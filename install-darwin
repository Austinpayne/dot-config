# osx specific install steps

# install homebrew
if ! command -v brew 2>&1 >/dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
fi
# install fzf
if ! command -v fzf 2>&1 >/dev/null; then
    brew install fzf
    /usr/local/opt/fzf/install
fi
# install brew bash completions
if ! brew list bash-completion 2>&1 >/dev/null; then
    brew install bash-completion
fi
cat <<EOF >> ~/.rc
# colorize ls
export CLICOLOR=1
# see: man ls
# default: LSCOLORS=exfxcxdxbxegedabagacad
BLACK=a
RED=b
GREEN=c
BROWN=d
BLUE=e
MAGENTA=f
CYAN=g
LIGHT_GREY=h
DARK_GREY=A
BOLD_RED=B
BOLD_GREEN=C
BOLD_BROWN=D
BOLD_BLUE=E
BOLD_MAGENTA=F
BOLD_CYAN=G
BRIGHT_WHITE=H
DEFAULT_FG_BG=x

# first char is foreground
# second char is background
DIRE=Ex
SYMB=Gx
SOCK=cx
PIPE=dx
EXEC=Cx
BLOC=eg
CHAR=ed
EXEU=ab
EXEG=ag
DIRS=ac
DIRN=ad

export LSCOLORS=\${DIRE}\${SYMB}\${SOCK}\${PIPE}\${EXEC}\${BLOC}\${CHAR}\${EXEU}\${EXEG}\${DIRS}\${DIRN}
EOF
cat <<EOF >> ~/.bashrc
# brew completions
[ -f "\$(brew --prefix)/etc/profile.d/bash_completion.sh" ] && source "\$(brew --prefix)/etc/profile.d/bash_completion.sh"
EOF
cat <<EOF >> ~/.zshrc
# key binds
# see: https://coderwall.com/p/a8uxma/zsh-iterm2-osx-shortcuts
# fixup option+left/right in iTerm
bindkey "[D" backward-word
bindkey "[C" forward-word
# fixup command+left/right in iTerm
bindkey "^[a" beginning-of-line
bindkey "^[e" end-of-line
EOF
# Add Xcode custom shortcuts
# see: https://stackoverflow.com/a/41121405
XCODE_BINDINGS="/Applications/Xcode.app/Contents/Frameworks/IDEKit.framework/Resources/IDETextKeyBindingSet.plist"
if [ -s "$XCODE_BINDINGS" ]; then
    echo "Installing custom Xcode bindings, please enter sudo password"
    read -r -d '' DUPLICATE_LINE <<EOF
    <key>Custom</key><dict>
        <key>Duplicate Current Line</key>
        <string>selectParagraph:, delete:, undo:, moveRight:, yankAndSelect:</string>
    </dict>
EOF
    export DUPLICATE_LINE
    # remove previous custom bindings
    sudo perl -i -0pE 's,<key>Custom</key><dict>.*?</dict>,,s' "$XCODE_BINDINGS" 2>&1 >/dev/null
    # add bindings
    sudo --preserve-env=DUPLICATE_LINE perl -i -0pe 's,</dict>\n</plist>,    $ENV{DUPLICATE_LINE}\n</dict>\n</plist>,' "$XCODE_BINDINGS" 2>&1 >/dev/null
    # remove blank lines
    sudo sed -i '' '/^[[:space:]]*$/d' "$XCODE_BINDINGS"
fi

